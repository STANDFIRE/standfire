<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title></title>
  <link rel="stylesheet" media="screen" type="text/css" href="./style.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="./design.css" />
  <link rel="stylesheet" media="print" type="text/css" href="./print.css" />

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<a href=.>start</a>&nbsp;=>&nbsp;<a href=help_en.html>help_en</a></br>

<h1 class="sectionedit101" id="samsaralight">SamsaraLight</h1>
<div class="level1">

</div>
<!-- EDIT101 SECTION "SamsaraLight" [1-28] -->
<h2 class="sectionedit102" id="introduction">Introduction</h2>
<div class="level2">

<p>
SamsaraLight is a library implementing the radiative balance of the Samsara model. This library was written in 2008 by Benoit Courbaud (IRSTEA Grenoble), Nicolas Dones (INRA Clermont-Ferrand) and François de Coligny (Capsis). In 2012, new features have been added by Benoit Courbaud (IRSTEA Grenoble), Gauthier Ligot (Ulg Belgium), Mathieu Jonard (UCL Belgium) and, of course, François de Coligny (Capsis).
</p>

</div>
<!-- EDIT102 SECTION "Introduction" [29-463] -->
<h2 class="sectionedit103" id="suggestions_and_todo_list">Suggestions and TODO list</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Implement computation of above canopy radiations without climate data. Some users are only interested in relative values of transmitted light and do not need accurate absolute values.</div>
</li>
<li class="level1"><div class="li"> Implement virtual sensors that can be placed in any location within the stand and measure amounts of transmitted light</div>
</li>
<li class="level1"><div class="li"> Crown reconstruction, see Piboule et al. (2005), AFS</div>
</li>
<li class="level1"><div class="li"> Verify equation for the share of energy between simulated beams</div>
</li>
<li class="level1"><div class="li"> Diffuse energy can be computed with UOC (b=0) and SOC (b=2) algorithm. Some studies have however showed that b=1.23 might be more suitable.</div>
</li>
<li class="level1"><div class="li"> Correction of the computation of potential energy at tree level (see L558 in SLModel)</div>
</li>
<li class="level1"><div class="li"> correction of the energy associated to the beam with zenithal angle lower than the minimum zenithal angle.</div>
</li>
</ul>

</div>
<!-- EDIT103 SECTION "Suggestions and TODO list" [464-1284] -->
<h2 class="sectionedit104" id="library_structure">Library structure</h2>
<div class="level2">

<p>
The below figure introduces the structure of SamsaraLight library and its implementation with <a href="help_en-quergus.html" class="wikilink1" title="help_en-quergus.html">Quergus</a>. This figure will be (and need to be) updated…
</p>

<p>
<a href="media/help_en/samsaralight-querguswithoutkernel.png" class="media" target="_blank" title="help_en:samsaralight-querguswithoutkernel.png"><img src="media/help_en/samsaralight-querguswithoutkernel.png" class="media" title="" alt="" /></a>
</p>

<p>
The core of the library is certainly the procedure <code>processLighting()</code> of <code>SLModel</code> class. Prior to its execution, a beamset is created with the <code>SLBeamSetFactory</code> class. It groups together direct and diffuse beams that are traced for each ground cell. Next, for each cell and ray, trees (and part of trees) that could potentially intercept ray are selected. Interceptions with ray are tested solving equation systems (interception between ellipsoid and a line). Intercepted tree parts (crown parts and trunks) are stored and sorted along the ray in <code>SLInterceptionItem</code> object. Then ray energy is decremented using either the turbid medium hypothesis or the porous envelop hypothesis. Intercepted energy (direct, diffuse, total with or without a slope correction) is then stored in each intercepted items (cell, crown parts, trunks, …).
SamsaraLight has only two interfaces that module must implements : <code>SLLightableTree</code>, which makes the connection with the SLTreeLight object, and <code>SLLightableCell</code> for the connection with <code>SLCellLight</code>. Nevertheless modules must instantiate <code>SLCellLight</code>, <code>SLTreeLight</code>, <code>SLTreePart</code>,  <code>SLModel</code> and load some settings. Some of the settings can straightly be loaded using the <code>SLSettingLoader</code> while other settings (plot settings like the latitude) must be set within modules.
</p>

</div>
<!-- EDIT104 SECTION "Library structure" [1285-2882] -->
<h2 class="sectionedit105" id="model_configuration">Model configuration</h2>
<div class="level2">

<p>
The settings of samsaraLight are all defined in <code>SLSettings</code>. Radiation details are loaded from a text file, while plot attibutes are set by modules. 
</p>

</div>
<!-- EDIT105 SECTION "Model configuration" [2883-3068] -->
<h3 class="sectionedit106" id="module_settings">Module settings</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> <code>plotLatitude</code> : plot latitude in degree</div>
</li>
<li class="level1"><div class="li"> <code>plotLongitude</code> : plot longitude in degree</div>
</li>
<li class="level1"><div class="li"> <code>plotSlope</code> : height angle of slope in degree (0° is a horizontal plot, 90° is a vertical plot) </div>
</li>
<li class="level1"><div class="li"> <code>plotAspect</code>: clock wise angle from the north to an axis parallel to the slope and going downward. It corresponds to the slope azimut looking downward.</div>
</li>
<li class="level1"><div class="li"> <code>northToXAngle_cw</code> : clock wise angle (degree) from the north to the x axis. It corresponds to the azimuth measuring looking towards the positive x axis. If the x and y axis are respectively oriented eastward and northward, this angle equals 90°.</div>
</li>
</ul>

<p>
Code example from Quergus.QGInventoryLoader :
</p>
<pre class="code java">SLSettings samsaraSettings <span class="sy0">=</span> model.<span class="me1">getSLModel</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getSettings</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">//...</span>
samsaraSettings.<span class="me1">setPlotLatitude_deg</span><span class="br0">&#40;</span>p.<span class="me1">lattitude</span><span class="br0">&#41;</span><span class="sy0">;</span>
samsaraSettings.<span class="me1">setPlotLongitude_deg</span><span class="br0">&#40;</span>p.<span class="me1">longitude</span><span class="br0">&#41;</span><span class="sy0">;</span>
samsaraSettings.<span class="me1">setNorthToXAngle_cw_deg</span><span class="br0">&#40;</span>90d<span class="br0">&#41;</span> <span class="sy0">;</span>
samsaraSettings.<span class="me1">setPlotSlope_deg</span><span class="br0">&#40;</span>p.<span class="me1">slope</span><span class="br0">&#41;</span><span class="sy0">;</span> 
samsaraSettings.<span class="me1">setPlotAspect_deg</span><span class="br0">&#40;</span>p.<span class="me1">aspect</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT106 SECTION "Module settings" [3069-4083] -->
<h3 class="sectionedit107" id="text_file_settings">Text file settings</h3>
<div class="level3">

<p>
The text file has two main parts. The first part contains keywords and associated values:
</p>
<pre class="code">turbid_medium = true 
trunk_interception = false 
direct_angle_step = 5 
height_angle_min = 10 
diffuse_angle_step = 15 
soc = true 
GMT = 1 
leaf_on_doy =  40 
leaf_off_doy = 250</pre>
<ul>
<li class="level1"><div class="li"> <code>turbid_medium</code> : if true, radiation transfer use the turbid medium hypothesis (Beer&#039;s law). If false, radiation interception is computed using the porous envelop hypothesis.</div>
</li>
<li class="level1"><div class="li"> <code>trunk_interception</code> : If true, the interception by trunks is enabled. Radiation interception by cell (or regeneration) is reduced when this option is enabled.</div>
</li>
<li class="level1"><div class="li"> <code>direct_angle_step</code> : Step angle use to create direct beams in degree if radiations are next given monthly. 15° correspond to a step of one hour. A 5° step should be preferred? This option has no effect if radiations are next given with the hourly format.</div>
</li>
<li class="level1"><div class="li"> <code>height_angle_min</code> : the minimum height angle of beams, i.e. the minimum angle between a horizontal plane and the beam.</div>
</li>
<li class="level1"><div class="li"> <code>diffuse_angle_step</code> : Step angle use to create diffuse beamset in degree. 15° correspond a step of one hour.</div>
</li>
<li class="level1"><div class="li"> <code>soc</code> : If true, the standard overcast sky algorithm is used to create diffuse beams (beams with an elevation angle close to the zenith, have greater energy). If false, the Uniform Overcast Sky algorithm is used.</div>
</li>
<li class="level1"><div class="li"> <code>GMT</code> : correction between meridian standard time and the nearest standard meridian time. In France the nearest standard meridian time is the Greenwich time or the universal time. Nevertheless the legal time corresponds to GMT+1  (GMT = 1) during the winter and GMT+2 (GMT=2) during the summer. If GMT=0 then the user must give the local time (corresponding to the nearest standard meridian). The procedure has not been tested for countries other than France and Belgium though! GMT value is used only with hourly radiation records. It is not used with monthly radiation records.</div>
</li>
<li class="level1"><div class="li"> <code>leaf_on_doy</code>  : day of year  corresponding  to the beginning of the vegetative period</div>
</li>
<li class="level1"><div class="li"> <code>leaf_off_doy</code> : day of year  corresponding  to the end of the vegetative period</div>
</li>
</ul>

<p>
The second part of this file contains a table with global radiations and the ration between diffuse and global energy. These meteorological informations can have two format : namely monthly and hourly format. With the monthly format, the table has three columns : month number, global radiation in MJ/m2 and the diffuse to global ratio. This table must contain 12 lines, i.e. one per month. But only days within the vegetative period and with an energy above 0 will be used in the simulations. For example, this part might be : 
</p>
<pre class="code">#Month	Global	Diffus/G
1	71.27760	0.5
2	127.8588	0.5
3	312.6255	0.5
4	415.0542	0.5
5	533.9946	0.5
6	421.6902	0.5
7	425.8980	0.5
8	345.9888	0.5
9	302.9040	0.5
10	181.0038	0.5
11	103.2462	0.5
12	64.91820	0.5</pre>

<p>
With the hourly format, the table has five columns : month number, day number, hour, global radiation in MJ/m2 and the diffuse to global ratio. The file must contain records for every hour of one year. But only days within the vegetative period and with an energy above 0 will be used in the simulations. Watch out that every hour must correspond to a unique meridian. On other words, <strong>use only the winter or summer time. Do not use both in the same file!</strong>.  For example, the first lines look like : 
</p>
<pre class="code">#Month	Day	Hour	global  (MJ/m²)	diffus/global
1	1	0	0	0.5
1	1	1	0	0.5
1	1	2	0	0.5
1	1	3	0	0.5
1	1	4	0	0.5
1	1	5	0	0.5
1	1	6	0	0.5
1	1	7	0	0.5
1	1	8	0	0.5
1	1	9	0.0222	0.5
1	1	10	0.0492	0.5
1	1	11	0.0978	0.5
1	1	12	0.1626	0.5
1	1	13	0.2052	0.5
1	1	14	0.2454	0.5
1	1	15	0.1278	0.5
1	1	16	0.033	0.5
1	1	17	0	0.5
1	1	18	0	0.5
1	1	19	0	0.5
1	1	20	0	0.5
1	1	21	0	0.5
1	1	22	0	0.5
1	1	23	0	0.5
1	2	0	0	0.5
1	2	1	0	0.5
1	2	2	0	0.5
1	2	3	0	0.5
1	2	4	0	0.5
1	2	5	0	0.5
1	2	6	0	0.5
1	2	7	0	0.5
1	2	8	0.0042	0.5
...</pre>

</div>
<!-- EDIT107 SECTION "Text file settings" [4084-8015] -->
<h2 class="sectionedit108" id="model_functioning">Model functioning</h2>
<div class="level2">

<p>
For each ground cell, many beams are created and traced from the hemisphere toward the cell. Those beams are grouped together in a set of beams which is created in the beginning of the simulation. Every beam as an azimut, an elevation angle (or height angle) and diffuse or direct energy.
</p>

<p>
<a href="media/help_en/azelzen.gif" class="media" target="_blank" title="help_en:azelzen.gif"><img src="media/help_en/azelzen.gif" class="media" title="Definition of height angle which is similar to elevation angle and azimut. source : http://www.sagarlab.blogspot.be/" alt="Definition of height angle which is similar to elevation angle and azimut. source : http://www.sagarlab.blogspot.be/" /></a>
</p>

</div>

<h4 id="diffuse_rays">Diffuse rays</h4>
<div class="level4">

<p>
Diffuse rays are created at regular intervals of height angle and azimuth. The intervals is given in the settings : <code>diffuse_angle_step</code> (say DAS). Those two angles vary from DAS/2 to PI/2.
</p>

<p>
The total diffuse energy (sum (global*Diffus/global)) is distributed between rays according to the standard overcast sky or the uniform overcast sky method.  
</p>
<pre class="code java"><span class="kw4">double</span> energy<span class="sy0">;</span>
<span class="kw4">double</span> meridianNb <span class="sy0">=</span> <span class="nu0">2</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span> <span class="sy0">/</span> diffuseAngleStep_rad<span class="sy0">;</span>
<span class="kw4">double</span> heightAInf <span class="sy0">=</span> heightAngle_rad <span class="sy0">-</span> diffuseAngleStep_rad <span class="sy0">/</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> sinInf <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>heightAInf<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> heightASup <span class="sy0">=</span> heightAngle_rad <span class="sy0">+</span> diffuseAngleStep_rad <span class="sy0">/</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> sinSup <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>heightASup<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span>SOC <span class="sy0">==</span> <span class="kw2">false</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="co1">// Uniform Overcast Sky, per square meter of a</span>
 <span class="co1">// horizontal plan</span>
 energy <span class="sy0">=</span> <span class="br0">&#40;</span><span class="nu0">2</span> <span class="sy0">*</span> totalDiffuse <span class="sy0">/</span> meridianNb<span class="br0">&#41;</span> <span class="sy0">*</span> <span class="br0">&#40;</span>sinSup <span class="sy0">*</span> sinSup <span class="sy0">-</span> sinInf <span class="sy0">*</span> sinInf<span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span> <span class="co1">// Standard Overcast Sky, Energy per square meter of a</span>
 <span class="co1">// horizontal plan</span>
 energy <span class="sy0">=</span> <span class="br0">&#40;</span><span class="nu0">6</span> <span class="sy0">*</span> totalDiffuse <span class="sy0">/</span> <span class="br0">&#40;</span><span class="nu0">7</span> <span class="sy0">*</span> meridianNb<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">*</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">pow</span><span class="br0">&#40;</span>sinSup, <span class="nu0">2</span><span class="br0">&#41;</span> <span class="sy0">-</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">pow</span><span class="br0">&#40;</span>sinInf, <span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">2</span> <span class="sy0">+</span> <span class="nu0">2</span> <span class="sy0">*</span>  <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">pow</span><span class="br0">&#40;</span>sinSup, <span class="nu0">3</span><span class="br0">&#41;</span> <span class="sy0">-</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">pow</span><span class="br0">&#40;</span>sinInf, <span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">3</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="co1">// in MJ/m2 on a plane perpendicular to the ray</span>
energy <span class="sy0">=</span> energy <span class="sy0">/</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>heightAngle_rad<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
Later on only rays with height angle greater than the minimum height angle (height_angle_min) and that do not intercept the ground (with sloping plot) are used. 
</p>
<pre class="code java"><span class="co1">// A beam is created only if it reaches the soil with an angle &gt;</span>
<span class="co1">// angleMin the cosinus of the angle between the vector</span>
<span class="co1">// orthogonal to slope and the beam must be higher than</span>
<span class="co1">// sin(angleMin) this cosinus is given by scalar</span>
<span class="kw4">double</span> scalar <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>slope_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>heightAngle_rad<span class="br0">&#41;</span>
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>slope_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>heightAngle_rad<span class="br0">&#41;</span>
	<span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>azimut <span class="sy0">-</span> bottomAzimut_rad<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span>scalar <span class="sy0">&gt;</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>angleMin_rad<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="co1">//...</span></pre>

</div>

<h4 id="direct_rays">Direct rays</h4>
<div class="level4">

<p>
The computation process differs with the format use in the settings to define the radiations (hourly or monthly format, see in the setting section). Next, similarly to diffuse radiation, only direct beams with height angle greater than the minimum height angle (height_angle_min) and that do not intercept the ground (with sloping plot) are traced.
</p>

<p>
The hourly radiation procedure has the advantage to avoid calculating how direct energy is shared between rays. Nevertheless, the procedure to compute the sun&#039;s position is litle more complicated and less precise.
</p>

</div>

<h5 id="monthly_radiation">Monthly radiation</h5>
<div class="level5">

<p>
For each month with direct energy above 0 MJ/m2, beams are created at regular intervals of hour angle according to the <code>direct_angle_step</code> (say BAS, Beam angle step). Their hour angle vary from BAS/2 to PI/2. For each month, simulation is therefore perfomed only for one day. The total direct energy is shared between direct rays according to the sinus of their hour height angle and day height angle.
</p>
<pre class="code java">heightAngle_rad <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">asin</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span>
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>hourAngle<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
azimut_rad <span class="sy0">=</span> sunAzimut<span class="br0">&#40;</span>latitude_rad, declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span>,hourAngle, heightAngle_rad, southAzimut_rad<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> hourSinHeightAng <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">*</span> angleStep_rad
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">*</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>hourAngle <span class="sy0">+</span> angleStep_rad <span class="sy0">/</span> <span class="nu0">2</span><span class="br0">&#41;</span> 
        <span class="sy0">-</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>hourAngle <span class="sy0">-</span> angleStep_rad <span class="sy0">/</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// in MJ/m2 on a horizontal plane</span>
energy <span class="sy0">=</span> directEnergy<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">*</span> hourSinHeightAng<span class="sy0">/</span> daySinHeightAng<span class="sy0">;</span> </pre>

</div>

<h5 id="hourly_radiation">Hourly radiation</h5>
<div class="level5">

<p>
Direct rays are created at regular intervals of one hour angle from 00:30 to 23:30. It corresponds to hourly meteorological records. For each month, only one representative day is simulated (see <code>SLBeamFactory.meanDoyPerMonth()</code>). And hourly energy are computed as the sum per hour of every month record (E_h_m = sum_d E_d_h_m, with d, h and m the indices of hour, day and month).
</p>

<p>
To direct beam, the sun&#039;s position need to be computed. It depends on the plot location and the local hour system. In order to take into account the difference between the mean solar time and the apparent solar time, a correction is implemented using en empirical equation of time (daily variation).
</p>

<p>
Some explanation of the below code :
</p>
<ul>
<li class="level1"><div class="li"> eot is the equation of time</div>
</li>
<li class="level1"><div class="li"> B is an angular transformation of the day number</div>
</li>
<li class="level1"><div class="li"> If it&#039;s 12:00 during the winter (GMT+1, winter time) in Belgium, then the local time corresponding to the nearest meridian (= greenwich meridian for belgium) is 11:00. The local time takes in account that the plot is not exactly on the standard meridian. The local time for a plot at longitude =5° is : meridian time + (5-0)/15 = 11:19:48.</div>
</li>
<li class="level1"><div class="li"> To compute the local solar time, we add estimates of the equation of time to the local time. </div>
</li>
</ul>
<pre class="code java"><span class="kw4">int</span> stdLongitude <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> <span class="br0">&#40;</span>longitude_rad <span class="sy0">/</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span> <span class="sy0">/</span> <span class="nu0">12</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// standard meridian</span>
<span class="kw4">double</span> B <span class="sy0">=</span> <span class="nu0">2</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span> <span class="sy0">*</span> meanDoy<span class="br0">&#91;</span>m<span class="br0">&#93;</span> <span class="sy0">/</span> <span class="nu0">365.242</span><span class="sy0">;</span> <span class="co1">//wikipedia</span>
<span class="kw4">double</span> eot <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">7.657</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>B<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">9.862</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="sy0">*</span>B <span class="sy0">+</span> <span class="nu0">3.599</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//minutes, wikipedia</span>
<span class="kw4">double</span> localTime <span class="sy0">=</span> <span class="sy0">-</span> GMT <span class="sy0">+</span> h <span class="sy0">+</span> <span class="nu0">0.5</span> <span class="sy0">+</span> <span class="br0">&#40;</span>longitude_rad <span class="sy0">-</span> stdLongitude<span class="br0">&#41;</span> <span class="sy0">/</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span><span class="sy0">*</span><span class="nu0">12</span><span class="sy0">;</span> <span class="co1">//hour</span>
<span class="kw4">double</span> localSolarTime <span class="sy0">=</span> localTime  <span class="sy0">+</span> eot<span class="sy0">/</span><span class="nu0">60</span> <span class="sy0">;</span> 
<span class="kw4">double</span> hourAngle <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span> <span class="sy0">/</span> <span class="nu0">12</span> <span class="sy0">*</span> <span class="br0">&#40;</span>localSolarTime <span class="sy0">-</span> <span class="nu0">12</span><span class="br0">&#41;</span><span class="sy0">;</span>		
heightAngle_rad <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">asin</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>m<span class="br0">&#93;</span><span class="br0">&#41;</span>
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>m<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>hourAngle<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
azimut_rad <span class="sy0">=</span> sunAzimut<span class="br0">&#40;</span>latitude_rad, declination_rad<span class="br0">&#91;</span>m<span class="br0">&#93;</span>,hourAngle, heightAngle_rad, southAzimut_rad<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT108 SECTION "Model functioning" [8016-13887] -->
<h3 class="sectionedit109" id="radiation_transfer">Radiation transfer</h3>
<div class="level3">

<p>
Two approaches are implemented in SamsaraLight to simulate the transmission of ray light through the canopy, namely the turbid medium and the porous envelop approaches. Only one approach can be used at a time. This is set in the setting file.
</p>

</div>

<h4 id="turbid_medium">Turbid medium</h4>
<div class="level4">

<p>
The Beer&#039;s law is used to predict the transmission of a monochromatic ray through an homogeneous medium. In such medium, the transmission depends on the light travel length inside the medium, the medium density and a coefficient of absorption (<a href="http://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law" class="urlextern" target="blank" title="http://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law"  rel="nofollow">http://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law</a>).
</p>

<p>
One way to predict light transmission through canopy is to consider it as a turbid medium for which the coefficient of absorption is a function of the leaf area density. Typically :
</p>

<p>
$ \frac{I}{I_0} = exp(- k \Omega LAD) $
</p>

<p>
where k is the coefficient of extinction that depends on the orientation and spatial distribution of leaves and branches. A clumping factor (omega) might be added to take into account the aggregation of leaves and breanches within crowns. This is implemented is <code>SLModel</code>:  
</p>
<pre class="code java"><span class="kw4">double</span> leafAreaDensity <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>SLCrownPart<span class="br0">&#41;</span> treePart<span class="br0">&#41;</span>.<span class="me1">getLeafAreaDensity</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> extinctionCoef <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>SLCrownPart<span class="br0">&#41;</span> treePart<span class="br0">&#41;</span>.<span class="me1">getExtinctionCoefficient</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
currentEnergy <span class="sy0">-=</span> interceptedE<span class="sy0">;</span>
<span class="kw4">double</span> interceptedE <span class="sy0">=</span> currentEnergy <span class="sy0">*</span> <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">-</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">exp</span><span class="br0">&#40;</span><span class="sy0">-</span>extinctionCoef <span class="sy0">*</span> clumpingFactor <span class="sy0">*</span> leafAreaDensity <span class="sy0">*</span> item.<span class="me1">getPathLength</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre>

</div>

<h4 id="porous_envelop">Porous envelop</h4>
<div class="level4">

<p>
As turbid medium model might be difficult to calibrate, we have implemented a porous envelop approach. Crowns can be considered as porous envelop with a fixed transmissivity (I/I0) that does not depends on the light travel distance through the crown. The transmissivity is given by <code>SLLightableTree</code> and is used in <code>SLModel</code>:
</p>
<pre class="code java"><span class="kw4">double</span> transmissivity <span class="sy0">=</span> lightableTree.<span class="me1">getCrownTransmissivity</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> interceptedE <span class="sy0">=</span> <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">-</span> transmissivity<span class="br0">&#41;</span> <span class="sy0">*</span> currentEnergy<span class="sy0">;</span></pre>

</div>
<!-- EDIT109 SECTION "Radiation transfer" [13888-15818] -->
<h3 class="sectionedit110" id="tree_description">Tree description</h3>
<div class="level3">

</div>

<h4 id="canopy">Canopy</h4>
<div class="level4">

<p>
Two different crown representations are implemented in SamsaraLight :  <code>SLEllipsoidalCrownPart</code> and <code>SLCrownFraction</code>. 
</p>

</div>

<h5 id="ellipsoidal_crown_part">Ellipsoidal Crown Part</h5>
<div class="level5">

<p>
The simplest is <code>SLEllipsoidalCrownPart</code> used one ellipsoid or two truncated ellipsoids. Truncated ellipsoids can be characterized with possibly different semi-axes : a, b and c. a, b, and c are respectively the semi-axis in East-West, Nort-South, bottom-top direction. They are positive. However the two ellispsoids share a common centre (x,y,z). z is typically the height of the maximum extension of crown. x and y are often the tree coordinates but it can be different (ex. With asynmetric crown). The constructor of SLEllipsoidalCrownPart is different for the creation of a single ellipsoid and for truncated ellipsoids. In the latter case, an additional boolean parameter is added to precise whether the crown part is the upper part. 
</p>

<p>
The leaf area density and the coefficient of extinction need to be set after the creation of each crown parts if the turbid medium hypothesis is used.  
</p>

<p>
The below code produces crown represented with only one ellipsoids :
</p>
<pre class="code java"><span class="kw4">double</span> a <span class="sy0">=</span> <span class="br0">&#40;</span>crownRadiusN<span class="sy0">+</span>crownRadiusS<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> b <span class="sy0">=</span> <span class="br0">&#40;</span>crownRadiusE<span class="sy0">+</span>crownRadiusW<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> c <span class="sy0">=</span> <span class="br0">&#40;</span>height <span class="sy0">-</span> crownBaseHeight<span class="br0">&#41;</span> <span class="sy0">/</span> 2d<span class="sy0">;</span>
<span class="kw4">double</span> xp <span class="sy0">=</span> x<span class="sy0">;</span>
<span class="kw4">double</span> yp <span class="sy0">=</span> y<span class="sy0">;</span>
<span class="kw4">double</span> zp <span class="sy0">=</span> z <span class="sy0">+</span> crownBaseHeight <span class="sy0">+</span> c<span class="sy0">;</span>
SLCrownPart p <span class="sy0">=</span> <span class="kw1">new</span> SLEllipsoidalCrownPart<span class="br0">&#40;</span>xp, yp, zp, a, b, c<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//constructor for one ellipsoid</span>
p.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span> 
p.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
crownParts <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+collections"><span class="kw3">Collections</span></a>.<span class="me1">singletonList</span><span class="br0">&#40;</span>p<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
Here is another and more complex example : 
</p>
<pre class="code java"><span class="kw4">double</span> a <span class="sy0">=</span> <span class="br0">&#40;</span>crownRadiusN<span class="sy0">+</span>crownRadiusS<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> b <span class="sy0">=</span> <span class="br0">&#40;</span>crownRadiusE<span class="sy0">+</span>crownRadiusW<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">double</span> c <span class="sy0">=</span> <span class="br0">&#40;</span>height <span class="sy0">-</span> CrownMaxExtension<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> xp <span class="sy0">=</span> x<span class="sy0">;</span>
<span class="kw4">double</span> yp <span class="sy0">=</span> y<span class="sy0">;</span>
<span class="kw4">double</span> zp <span class="sy0">=</span> z <span class="sy0">+</span> crownBaseHeight <span class="sy0">+</span> c<span class="sy0">;</span>
SLCrownPart p <span class="sy0">=</span> <span class="kw1">new</span> SLEllipsoidalCrownPart<span class="br0">&#40;</span>xp, yp, zp, a, b, c, <span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//constructor for the upper ellipsoid</span>
p.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
p.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
crownParts.<span class="me1">add</span><span class="br0">&#40;</span>p<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">//a second and different ellipsoid</span>
c <span class="sy0">=</span> <span class="br0">&#40;</span>CrownMaxExtension <span class="sy0">-</span> crownBaseHeight<span class="br0">&#41;</span> <span class="sy0">;</span>
SLCrownPart p <span class="sy0">=</span> <span class="kw1">new</span> SLEllipsoidalCrownPart<span class="br0">&#40;</span>xp, yp, zp, a, b, c, <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">//constructor for the lower ellipsoid</span>
p.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span> 
p.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
crownParts.<span class="me1">add</span><span class="br0">&#40;</span>p<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>

<h5 id="crown_fraction">Crown Fraction</h5>
<div class="level5">

<p>
With <code>SLCrownFraction</code> crowns are divided in 8 parts. Each part has 6 parameters : three for the center coordinates et three semi-axes. The semis axis can be negative or positive depending on the part position within the crown. As previously, the leaf area density and the coefficient of extinction can be defined for every crown part. For example, parts located in the above the center has a vertical semi-axes that is positive. Those located below has a vertical semi-axis that is negative.
</p>
<pre class="code java"><span class="kw4">double</span> x0 <span class="sy0">=</span> x<span class="sy0">;</span> <span class="co1">//x, y, z are tree coordinates</span>
<span class="kw4">double</span> y0 <span class="sy0">=</span> y<span class="sy0">;</span>
<span class="kw4">double</span> z0 <span class="sy0">=</span> z <span class="sy0">+</span> largestCrownExtensionheight<span class="sy0">;</span>
&nbsp;
<span class="kw4">double</span> rup <span class="sy0">=</span> height <span class="sy0">-</span> largestCrownExtensionheight<span class="sy0">;</span>
<span class="kw4">double</span> rdown <span class="sy0">=</span> largestCrownExtensionheight <span class="sy0">-</span> CrownBaseHeight<span class="sy0">;</span>
&nbsp;
f1 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, reast, rnorth, rup<span class="br0">&#41;</span><span class="sy0">;</span>
f2 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, reast, <span class="sy0">-</span>rsouth, rup<span class="br0">&#41;</span><span class="sy0">;</span>
f3 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, <span class="sy0">-</span>rwest, <span class="sy0">-</span>rsouth, rup<span class="br0">&#41;</span><span class="sy0">;</span>
f4 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, <span class="sy0">-</span>rwest, rnorth, rup<span class="br0">&#41;</span><span class="sy0">;</span>
f5 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, reast, rnorth, <span class="sy0">-</span>rdown<span class="br0">&#41;</span><span class="sy0">;</span>
f6 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, reast, <span class="sy0">-</span>rsouth, <span class="sy0">-</span>rdown<span class="br0">&#41;</span><span class="sy0">;</span>
f7 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, <span class="sy0">-</span>rwest, <span class="sy0">-</span>rsouth, <span class="sy0">-</span>rdown<span class="br0">&#41;</span><span class="sy0">;</span>
f8 <span class="sy0">=</span> <span class="kw1">new</span> SLCrownFraction<span class="br0">&#40;</span>x0, y0, z0, <span class="sy0">-</span>rwest, rnorth, <span class="sy0">-</span>rdown<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
f1.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f2.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f3.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f4.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
f5.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
f6.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
f7.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
f8.<span class="me1">setLeafAreaDensity</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
f1.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f2.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f3.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span> 
f4.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span>
f5.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span>
f6.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span>
f7.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span>
f8.<span class="me1">setExtinctionCoefficient</span><span class="br0">&#40;</span><span class="nu0">0.5</span><span class="br0">&#41;</span><span class="sy0">;</span>
crownParts <span class="sy0">=</span> <span class="kw1">new</span> ArrayList<span class="sy0">&lt;</span>SLCrownPart<span class="sy0">&gt;</span> <span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f1<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f2<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f3<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f4<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f5<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f6<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f7<span class="br0">&#41;</span><span class="sy0">;</span>
crownParts.<span class="me1">add</span> <span class="br0">&#40;</span>f8<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>

<h4 id="trunk">trunk</h4>
<div class="level4">

<p>
Trunk are considered as cylinder with a a given diameter and height. They do no transmit light.
</p>

<p>
Similarly to crown parts, trunks need to be created in modules. For example, in Heterofor trunk are created with diameter equals to dbh and with a height equals to crown base height.
</p>
<pre class="code java">trunk <span class="sy0">=</span> <span class="kw1">new</span> SLTrunk<span class="br0">&#40;</span>x,y,z,dbh,hcb<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT110 SECTION "Tree description" [15819-20413] -->
<h3 class="sectionedit111" id="virtual_sensors">Virtual sensors</h3>
<div class="level3">

<p>
Since February 2013, virtual sensors can be added in a scene. They store the intercepted radiation energy (MJ/m²) and, optionally, the corresponding measured value (e.g. irradiance measured with real sensors in the field). They are defined with their coordinates (x,y) and their height above the grid (or the ground). 
</p>

<p>
<a href="media/help_en/virtualsensor.png" class="media" target="_blank" title="help_en:virtualsensor.png"><img src="media/help_en/virtualsensor.png" class="media" title="Visualization of 2 columns of five virtual sensor. Note: the regeneration box have the same color but is bigger" alt="Visualization of 2 columns of five virtual sensor. Note: the regeneration box have the same color but is bigger" width="200" /></a>
</p>

<p>
And here is some results (such results are available in SamsaraLight logs):
</p>
<pre class="code">SLModel.processLighting() - cell light - SquareCell_[41, 59] PACL = 45.13472 (x 59.03950119018555 y 61.16849899291992)
SLModel.processLighting() - cell light - SquareCell_[49, 41] PACL = 30.14904 (x 41.03950119018555 y 53.16849899291992)
SLModel.processLighting() - sensor light - ID = 1 height = 0.0 PACL = 45.134721456189325 intercepted items nb 417 (x 59.0395011901855 y 61.16849899291992)
SLModel.processLighting() - sensor light - ID = 2 height = 5.0 PACL = 60.06213118628673 intercepted items nb 281 (x 59.0395011901855 y 61.16849899291992)
SLModel.processLighting() - sensor light - ID = 3 height = 10.0 PACL = 34.16311483453394 intercepted items nb 346 (x 59.0395011901855 y 61.16849899291992)
SLModel.processLighting() - sensor light - ID = 4 height = 15.0 PACL = 17.251482827052445 intercepted items nb 208 (x 59.0395011901855 y 61.16849899291992)
SLModel.processLighting() - sensor light - ID = 5 height = 20.0 PACL = 99.99994899098216 intercepted items nb 0 (x 59.0395011901855 y 61.16849899291992)
SLModel.processLighting() - sensor light - ID = 6 height = 0.0 PACL = 30.149039881265104 intercepted items nb 526 (x 41.03950119018555 y 53.16849899291992)
SLModel.processLighting() - sensor light - ID = 7 height = 5.0 PACL = 16.805923490426867 intercepted items nb 415 (x 41.1 y 53.6)
SLModel.processLighting() - sensor light - ID = 8 height = 10.0 PACL = 4.36826718157072 intercepted items nb 529 (x 41.1 y 53.6)
SLModel.processLighting() - sensor light - ID = 9 height = 15.0 PACL = 9.444025456719668 intercepted items nb 247 (x 41.1 y 53.6)
SLModel.processLighting() - sensor light - ID = 10 height = 20.0 PACL = 25.1333197899623 intercepted items nb 202 (x 41.1 y 53.6)
SLModel.processLighting() - sensor light - ID = 11 height = 25.0 PACL = 99.99994899098216 intercepted items nb 0 (x 41.1 y 53.6)</pre>

</div>
<!-- EDIT111 SECTION "Virtual sensors" [20414-22821] -->
<h3 class="sectionedit112" id="dealing_with_edges">Dealing with edges</h3>
<div class="level3">

<p>
The estimates of intercepted light (by trees or cells) are, without correction, clearly erroneous around plot borders. Incident light is indeed overestimated as the interception by trees located outside of the plot is not taken into account. 
</p>

<p>
Two corrections are implemented in SamsaraLight : (1) limit beam height angle and (2) a torus repetition of the plot. 
</p>

</div>

<h4 id="minimum_height_angle">Minimum height angle</h4>
<div class="level4">

<p>
Diffuse and direct beams with height angle less than the minimum height angle are not created (see <code>height_angle_min</code> in the settings). Rays with low height angle are indeed most of the time fully intercepted by trees located outside of the plot.
</p>

</div>

<h4 id="torus_system">Torus system</h4>
<div class="level4">

<p>
In order to avoid overestimation of incident radiation coming from the edges, the plot is repeated in every direction. This system works only if plots are rectangular with a constant slope.
</p>

<p>
<a href="media/help_en/torus.jpg" class="media" target="_blank" title="help_en:torus.jpg"><img src="media/help_en/torus.jpg" class="media" title="A piece of art by Benoît Courbaud (2003) ;-) " alt="A piece of art by Benoît Courbaud (2003) ;-) " /></a>
</p>

</div>
<!-- EDIT112 SECTION "Dealing with edges" [22822-23776] -->
<h3 class="sectionedit113" id="optimization">Optimization</h3>
<div class="level3">

</div>

<h4 id="tree_interception">Tree interception</h4>
<div class="level4">

<p>
For each traced ray, an optimization procedure has been written to select trees that could potentially intercept the ray. In fact cells are first selected along the horizontal projection of the ray. This creates a rectangular zone with :
</p>
<ul>
<li class="level1"><div class="li"> width (R) = maximum crown radius with a correction for cell width and ray azimuth (?)</div>
</li>
<li class="level1"><div class="li"> length (L) = horizontal projection of (maximum height * 1.25) + R</div>
</li>
</ul>
<pre class="code java"><span class="kw4">double</span> Hmax <span class="sy0">=</span> treeMaxHeight <span class="sy0">*</span> <span class="nu0">1.25</span><span class="sy0">;</span>
<span class="kw4">double</span> cRadius <span class="sy0">=</span> maxCrownRadius<span class="sy0">;</span> <span class="co1">// max crown radius (meters)</span>
<span class="kw4">double</span> lateral <span class="sy0">=</span> width <span class="sy0">/</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sqrt</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>azt <span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">PI</span> <span class="sy0">/</span> <span class="nu0">4</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> R <span class="sy0">=</span> cRadius <span class="sy0">+</span> lateral<span class="sy0">;</span>
<span class="kw4">double</span> L <span class="sy0">=</span> Hmax <span class="sy0">/</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">tan</span><span class="br0">&#40;</span>hAngle<span class="br0">&#41;</span> <span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>azimut <span class="sy0">-</span> bottomAzimut_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">tan</span><span class="br0">&#40;</span>slope<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> lateral<span class="sy0">;</span></pre>

<p>
This procedure written in <code>SLModel.computeRelativeCellNeighbourhoods()</code> has to be called in the model class of the modules using SamsaraLight before <code>SLModel.processLight()</code> :
</p>
<pre class="code java">slModel.<span class="me1">init</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
slModel.<span class="me1">computeRelativeCellNeighbourhoods</span> <span class="br0">&#40;</span>initStand,treeMaxHeight, cellWidth, maxCrownRadius<span class="br0">&#41;</span><span class="sy0">;</span>
slModel.<span class="me1">processLighting</span> <span class="br0">&#40;</span>initStand<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>

<h4 id="cells_to_enlight">Cells to enlight</h4>
<div class="level4">

<p>
It is possible to restrict number of cells that will be targeted by rays. Those cells should then be added in the list <code>celltoEnlight</code> of <code>SLSettings</code>. If this list is empty (default) then beams will be traced torward every cell of the grid.
</p>

<p>
This optimization procedure is only interesting if users do not want estimate of the energy intercepted by trees. This is mainly used to compare observation of ground transmitted light with model estimates (see in <code>SLModel</code>).
</p>

</div>

<h4 id="virtual_sensor_to_enlight">Virtual sensor to enlight</h4>
<div class="level4">

<p>
By default, SamsaraLight computes the light balance for every targeted cells and loaded virtual sensors. It is possible to avoid simulating the enlightening of the cells and, hence, to enlighten only the virtual sensors. For this purpose, the module needs to set SLSettings.setSensorLightOnly(true).
</p>

</div>
<!-- EDIT113 SECTION "Optimization" [23777-25735] -->
<h2 class="sectionedit114" id="model_outputs">Model outputs</h2>
<div class="level2">

</div>
<!-- EDIT114 SECTION "Model outputs" [25736-25762] -->
<h3 class="sectionedit115" id="cells">Cells</h3>
<div class="level3">

<p>
9 variables are computed at the cell level. They indicate the amount of transmitted energy available on the ground. They differ from the type of energy considered (diffuse, direct, total), the plane on which the energy is projected (horizontal plane, parallel to slope, perpendicular to beam) and whether it is an absolute or relative measure. Energy amount projected on a plane parallel to the slope correspond to what could have been measured with a sensor lying on the ground. In this case, rays perpendicular to the slope bring more energy than vertical rays. 
</p>
<ul>
<li class="level1"><div class="li"> getDirectEnergy() = amount of direct energy (MJ/m2) projected on a plane parallel to the slope </div>
</li>
<li class="level1"><div class="li"> getDiffuseEnergy() = amount of diffuse energy (MJ/m2) projected on a plane parallel to the slope </div>
</li>
<li class="level1"><div class="li"> getTotalEnergy() = amount of direct + diffuse energy (MJ/m2) projected on a plane parallel to the slope </div>
</li>
<li class="level1"><div class="li"> getRelativeSlopeEnergy() = ratio (%) between total transmitted energy and above canopy energy projected on a plane parallel to the slope</div>
</li>
<li class="level1"><div class="li"> getRelativeDiffuseSlopeEnergy() = ratio (%) between transmitted diffuse energy and above canopy diffuse energy projected on a plane parallel to the slope</div>
</li>
<li class="level1"><div class="li"> getRelativeDirectSlopeEnergy() = ratio (%) between transmitted direct energy and above canopy diffuse energy projected on a plane parallel to the slope</div>
</li>
<li class="level1"><div class="li"> getRelativeHorizontalEnergy() = ration (%) between transmitted total energy projected horizontally and the total above canopy energy projected horizontally (corrected the 10/03/2012)</div>
</li>
<li class="level1"><div class="li"> getRelativeDiffuseHorizontalEnergy() = ration (%) between transmitted diffuse energy projected horizontally and the diffuse above canopy energy projected horizontally(corrected the 10/03/2012)</div>
</li>
<li class="level1"><div class="li"> getRelativeDirectHorizontalEnergy() = ration (%) between transmitted direct energy projected horizontally and the direct above canopy energy projected horizontally</div>
</li>
</ul>
<pre class="code java"><span class="kw4">double</span> hAngle <span class="sy0">=</span> beam.<span class="me1">getHeightAngle_rad</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> azimut <span class="sy0">=</span> beam.<span class="me1">getAzimut_rad</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// beam energy in MJ/m2 on a plane orthogonal to beam direction</span>
<span class="kw4">double</span> beamEnergy <span class="sy0">=</span> beam.<span class="me1">getInitialEnergy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
&nbsp;
<span class="co1">// Projection of energy on plane parallel to slope in MJ/m2.</span>
<span class="kw4">double</span> scalar <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>slope_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>hAngle<span class="br0">&#41;</span>
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>slope_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>hAngle<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>azimut <span class="sy0">-</span> bottomAzimut<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> initEnergy <span class="sy0">=</span> scalar <span class="sy0">*</span> beamEnergy<span class="sy0">;</span>
&nbsp;
<span class="co1">// Projection of energy on a horizontal plane in MJ/m2. (GL - 3 Oct. 2012)</span>
<span class="kw4">double</span> scalarHorizontal <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>hAngle<span class="br0">&#41;</span>
 <span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>hAngle<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>azimut <span class="sy0">-</span> bottomAzimut<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> initEnergyHorizontal <span class="sy0">=</span> scalarHorizontal <span class="sy0">*</span> beamEnergy<span class="sy0">;</span>
&nbsp;
<span class="co1">// From MJ/m2 to MJ.</span>
initEnergy <span class="sy0">=</span> initEnergy <span class="sy0">*</span> cellSurface<span class="sy0">;</span>
initEnergyHorizontal <span class="sy0">=</span> initEnergyHorizontal <span class="sy0">*</span> cellHorizontalSurface<span class="sy0">;</span>
<span class="kw4">double</span> currentEnergy <span class="sy0">=</span> initEnergy<span class="sy0">;</span>
<span class="kw4">double</span> currentHorizontalEnergy <span class="sy0">=</span> initEnergyHorizontal<span class="sy0">;</span>
&nbsp;
<span class="co1">//...</span>
<span class="co1">//loop on every beams and interception</span>
<span class="co1">//...</span>
 <span class="co1">// Cell energy is in MJ/m2 and projected on a plane parallel to the slope</span>
 cellTotalEnergy <span class="sy0">+=</span> currentEnergy <span class="sy0">/</span> cellSurface<span class="sy0">;</span>
 cellTotalHorizontalEnergy <span class="sy0">+=</span> currentHorizontalEnergy <span class="sy0">/</span> cellHorizontalSurface<span class="sy0">;</span>  <span class="sy0">/</span>
&nbsp;
 <span class="kw1">if</span> <span class="br0">&#40;</span>beam.<span class="me1">isDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  cellDirectEnergy <span class="sy0">+=</span> currentEnergy <span class="sy0">/</span> cellSurface<span class="sy0">;</span>
  cellDirectHorizontalEnergy <span class="sy0">+=</span> currentHorizontalEnergy <span class="sy0">/</span> cellHorizontalSurface<span class="sy0">;</span>
 <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
 cellDiffuseEnergy <span class="sy0">+=</span> currentEnergy <span class="sy0">/</span> cellSurface<span class="sy0">;</span>
 cellDiffuseHorizontalEnergy <span class="sy0">+=</span> currentHorizontalEnergy <span class="sy0">/</span> cellHorizontalSurface<span class="sy0">;</span>
 <span class="br0">&#125;</span>
&nbsp;
<span class="co1">//...</span>
<span class="co1">//end of loop</span>
<span class="co1">//...</span>
&nbsp;
cellLight.<span class="me1">setDirectEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> cellDirectEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setDiffuseEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> cellDiffuseEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setTotalEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> cellTotalEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">double</span> relativeSlopeEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellTotalEnergy <span class="sy0">/</span> <span class="br0">&#40;</span>beamSet.<span class="me1">getSlopeDiffuse</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> beamSet.<span class="me1">getSlopeDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> relativeSlopeDiffuseEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellDiffuseEnergy <span class="sy0">/</span> beamSet.<span class="me1">getSlopeDiffuse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> relativeSlopeDirectEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellDirectEnergy<span class="sy0">/</span> beamSet.<span class="me1">getSlopeDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">//...</span>
cellLight.<span class="me1">setRelativeSlopeEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeSlopeEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setRelativeDiffuseSlopeEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeSlopeDiffuseEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setRelativeDirectSlopeEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeSlopeDirectEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">double</span> relativeHorizontalEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellTotalHorizontalEnergy <span class="sy0">/</span> <span class="br0">&#40;</span>beamSet.<span class="me1">getHorizontalDiffuse</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> beamSet.<span class="me1">getHorizontalDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> relativeHorizontalDiffuseEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellDiffuseHorizontalEnergy <span class="sy0">/</span> beamSet.<span class="me1">getHorizontalDiffuse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> relativeHorizontalDirectEnergy <span class="sy0">=</span> <span class="nu0">100</span> <span class="sy0">*</span> cellDirectHorizontalEnergy <span class="sy0">/</span> beamSet.<span class="me1">getHorizontalDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
cellLight.<span class="me1">setRelativeHorizontalEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeHorizontalEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setRelativeDiffuseHorizontalEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeHorizontalDiffuseEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
cellLight.<span class="me1">setRelativeDirectHorizontalEnergy</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#41;</span> relativeHorizontalDirectEnergy<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT115 SECTION "Cells" [25763-30445] -->
<h3 class="sectionedit116" id="tree_parts">Tree Parts</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> getDirectEnergy() = amount of direct energy (MJ) projected on plane parallel to slope</div>
</li>
<li class="level1"><div class="li"> getDiffuseEnergy() = amount of direct energy (MJ) projected on plane parallel to slope</div>
</li>
</ul>
<pre class="code java"><span class="co1">//current energy is the projection of energy on plane parallel to slope in MJ.</span>
<span class="kw4">double</span> interceptedE <span class="sy0">=</span> <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">-</span> transmissivity<span class="br0">&#41;</span> <span class="sy0">*</span> currentEnergy<span class="sy0">;</span> <span class="co1">//porous envelop</span>
<span class="kw1">if</span> <span class="br0">&#40;</span>beam.<span class="me1">isDirect</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
 treePart.<span class="me1">addDirectEnergy</span><span class="br0">&#40;</span>interceptedE<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
 treePart.<span class="me1">addDiffuseEnergy</span><span class="br0">&#40;</span>interceptedE<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
<ul>
<li class="level1"><div class="li"> getPotentitalenergy() = energy (MJ) that would have been intercepted by the tree part without any neighbouring tree parts. This can be used as an explanatory variable of tree growth. <strong>It&#039;s written in the code that the computations are wrong! It needs to be validated!</strong></div>
</li>
</ul>
<pre class="code java"><span class="kw4">double</span> potCurrentEnergy <span class="sy0">=</span> getPotCurrentEnergy<span class="br0">&#40;</span>lightableTree, initEnergy<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw4">double</span> potCrownInterceptedE <span class="sy0">=</span> potCurrentEnergy	<span class="sy0">*</span> <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">-</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">exp</span><span class="br0">&#40;</span><span class="sy0">-</span>extinctionCoef	<span class="sy0">*</span> clumpingFactor <span class="sy0">*</span> leafAreaDensity <span class="sy0">*</span> item.<span class="me1">getPathLength</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
treePart.<span class="me1">addPotentialEnergy</span><span class="br0">&#40;</span>potCrownInterceptedE<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// IT'S WRONG</span>
decrementPotCurrentEnergy<span class="br0">&#40;</span>lightableTree,potCrownInterceptedE<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT116 SECTION "Tree Parts" [30446-31581] -->
<h2 class="sectionedit117" id="interception_computations">Interception computations</h2>
<div class="level2">

</div>
<!-- EDIT117 SECTION "Interception computations" [31582-31620] -->
<h3 class="sectionedit118" id="beam_equation">Beam equation</h3>
<div class="level3">

<p>
$ x = L cos \beta cos \alpha $
</p>

<p>
$ y = L cos \beta sin \alpha $
</p>

<p>
$ z = L sin \beta $
</p>

<p>
Mixing this parametric equation of a beam with the equation of a crown part (or a trunk) lead to a quadratic equation that looks like : $AL^2+BL+C=0$. This equation can have 0, 1 or 2 solutions.
</p>

</div>
<!-- EDIT118 SECTION "Beam equation" [31621-31925] -->
<h3 class="sectionedit119" id="trunk_equation">Trunk equation</h3>
<div class="level3">

<p>
The trunks are cylinder with center at ($x_0$, $y_0$, $z_0$) and with a radius $r$:
</p>

<p>
$ (x - x_0)^2 + (y - y_0)^2 = r^2 $
</p>

<p>
$ x^2 + x_0^2 - 2xx_0 + y^2 + y_0^2 - 2yy_0 - r^2 = 0 $
</p>

<p>
The interception points are therefore computed solving the quadric following equation : 
</p>

<p>
$L^2 cos^2 \beta cos^2 \alpha + x_0^2 - 2 L cos \beta cos \alpha x_0 + L^2 cos^2 \beta sin^2 \alpha + y_0^2 - 2 L cos \beta sin \alpha y _0 - r^2 = 0 $
</p>

<p>
$ A = cos^2 \beta $
</p>

<p>
$ B = - 2 cos \beta cos \alpha x_0 - 2 cos \beta sin \alpha y _0$
</p>

<p>
$ C = x_0^2 + y_0^2 - r^2 $
</p>

</div>
<!-- EDIT119 SECTION "Trunk equation" [31926-32489] -->
<h3 class="sectionedit120" id="ellipsoid_crown_part">Ellipsoid crown part</h3>
<div class="level3">

<p>
$\frac{(x-x_0)^2}{a^2} + \frac{(y-y_0)^2}{b^2} + \frac{(z-z_0)^2}{c^2} = 1$
</p>

<p>
The interception equation is :
</p>

<p>
$ A = \frac{cos^2 \beta cos^2 \alpha}{a^2} + \frac{cos^2 \beta sin^2 \alpha}{b^2} + \frac{sin^2 \beta}{c^2} $
</p>

<p>
$ B = \frac{- 2 cos \beta cos \alpha x_0}{a^2} + \frac{- 2 cos \beta sin \alpha y_0}{b^2} + \frac{-2 sin \beta z_0}{c^2} $
</p>

<p>
$ C = \frac{x_0^2}{a^2} + \frac{y_0^2}{b^2} + \frac{z_0^2}{c^2} - 1 $
</p>

</div>
<!-- EDIT120 SECTION "Ellipsoid crown part" [32490-32937] -->
<h3 class="sectionedit121" id="algorithm">Algorithm</h3>
<div class="level3">

<p>
This algorithm has been updated in February 2013. It is now more general and allow the computation of the radiative balance and height greater than 0 (See figure below). This algorithm computes first all potential point of intersection between the beam, the tree part limits and the ground plane. Next, itercepted items need to have the two roots that respect all the conditions. 
</p>

</div>
<!-- EDIT121 SECTION "Algorithm" [32938-33341] -->
<h2 class="sectionedit122" id="useful_definitions">Useful definitions</h2>
<div class="level2">

<p>
source : <a href="http://www.powerfromthesun.net/Book/chapter03/chapter03.html" class="urlextern" target="blank" title="http://www.powerfromthesun.net/Book/chapter03/chapter03.html"  rel="nofollow">http://www.powerfromthesun.net/Book/chapter03/chapter03.html</a>
</p>
<ul>
<li class="level1"><div class="li"> <strong>Sun&#039;s declination</strong>: The declination of the Sun is the angle between the rays of the Sun and the plane of the Earth&#039;s equator. Because earth axial tilt is nearly constant, solar declination varies with the seasons and its period is one year.</div>
</li>
<li class="level1"><div class="li"> <strong>Sun&#039;s hour angle</strong>: The hour angle is the angular displacement of the sun east or west of the local meridian due to rotation of the earth on its axis at 15° per hour with morning being negative and afternoon being positive.</div>
</li>
<li class="level1"><div class="li"> <strong>Sun&#039;s day angle</strong>:</div>
</li>
</ul>
<pre class="code java">daySinHeightAng <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span><span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">*</span> <span class="br0">&#40;</span>sunSetHourAng <span class="sy0">-</span> sunRiseHourAng<span class="br0">&#41;</span>
	<span class="sy0">+</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>latitude_rad<span class="br0">&#41;</span> <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">cos</span><span class="br0">&#40;</span>declination_rad<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span>
        <span class="sy0">*</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>sunSetHourAng<span class="br0">&#41;</span> <span class="sy0">-</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">sin</span><span class="br0">&#40;</span>sunRiseHourAng<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>
<!-- EDIT122 SECTION "Useful definitions" [33342-34201] -->
<h2 class="sectionedit123" id="references">References</h2>
<div class="level2">

</div>
<!-- EDIT123 SECTION "References" [34202-34224] -->
<h3 class="sectionedit124" id="scientific_papers">Scientific papers</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> B. Courbaud, F. de Coligny and T. Cordonnier (2003) Simulating radiation distribution in a heterogeneous Norway spruce forest on a slope, Agricultural and Forest Meteorology, 116 (1–2), 1-18.</div>
</li>
</ul>

</div>
<!-- EDIT124 SECTION "Scientific papers" [34225-34451] -->
<h3 class="sectionedit125" id="internet_documentation">Internet documentation</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> <a href="http://www.appropedia.org/The_solar_resource" class="urlextern" target="blank" title="http://www.appropedia.org/The_solar_resource"  rel="nofollow">http://www.appropedia.org/The_solar_resource</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.new-learn.info/packages/clear/thermal/climate/sun/angle_incidence.html" class="urlextern" target="blank" title="http://www.new-learn.info/packages/clear/thermal/climate/sun/angle_incidence.html"  rel="nofollow">Computing the angle of incidence</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.powerfromthesun.net/Book/" class="urlextern" target="blank" title="http://www.powerfromthesun.net/Book/"  rel="nofollow">http://www.powerfromthesun.net/Book/</a></div>
</li>
</ul>

</div>
<!-- EDIT125 SECTION "Internet documentation" [34452-34787] -->
<h2 class="sectionedit126" id="contacts">Contacts</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="mailto:&#x42;&#x65;&#x6e;&#x6f;&#x69;&#x74;&#x2e;&#x43;&#x6f;&#x75;&#x72;&#x62;&#x61;&#x75;&#x64;&#x40;&#x69;&#x72;&#x73;&#x74;&#x65;&#x61;&#x2e;&#x66;&#x72;" class="mail" title="&#x42;&#x65;&#x6e;&#x6f;&#x69;&#x74;&#x2e;&#x43;&#x6f;&#x75;&#x72;&#x62;&#x61;&#x75;&#x64;&#x40;&#x69;&#x72;&#x73;&#x74;&#x65;&#x61;&#x2e;&#x66;&#x72;">Benoît Courbaud</a></div>
</li>
<li class="level1"><div class="li"> <a href="mailto:&#x67;&#x6c;&#x69;&#x67;&#x6f;&#x74;&#x40;&#x75;&#x6c;&#x67;&#x2e;&#x61;&#x63;&#x2e;&#x62;&#x65;" class="mail" title="&#x67;&#x6c;&#x69;&#x67;&#x6f;&#x74;&#x40;&#x75;&#x6c;&#x67;&#x2e;&#x61;&#x63;&#x2e;&#x62;&#x65;">Gauthier Ligot</a></div>
</li>
</ul>

</div>
<!-- EDIT126 SECTION "Contacts" [34788-] --></body>
</html>
